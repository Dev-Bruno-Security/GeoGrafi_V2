# ğŸ—ï¸ Arquitetura - GeoGrafi v2.0 com API REST e n8n

## ğŸ“ Diagrama da Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CAMADA DE APRESENTAÃ‡ÃƒO                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Streamlit Web UI â”‚    â”‚  API REST Docs   â”‚    â”‚ n8n Node  â”‚ â”‚
â”‚  â”‚  (Port 8501)     â”‚    â”‚  (Port 8000)     â”‚    â”‚           â”‚ â”‚
â”‚  â”‚                  â”‚    â”‚                  â”‚    â”‚           â”‚ â”‚
â”‚  â”‚ â€¢ Upload CSV     â”‚    â”‚ â€¢ Swagger UI     â”‚    â”‚ HTTP Req  â”‚ â”‚
â”‚  â”‚ â€¢ Config API     â”‚    â”‚ â€¢ OpenAPI 3.0    â”‚    â”‚           â”‚ â”‚
â”‚  â”‚ â€¢ Manage Keys    â”‚    â”‚ â€¢ Test Endpoint  â”‚    â”‚           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                       â”‚                     â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                       â”‚                     â”‚
            â–¼                       â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CAMADA DE APLICAÃ‡ÃƒO                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              FastAPI Application (api_server.py)         â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚  /api/*    â”‚  â”‚  Auth      â”‚  â”‚  Logger   â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  Endpoints â”‚  â”‚  Check     â”‚  â”‚  & Audit  â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚        APIKeyManager (api_key_manager.py)         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Generate Keys  â€¢ Validate Keys                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Track Usage    â€¢ List/Delete Keys             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Streamlit Application (app.py)                  â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚           Pages/Components                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ğŸ“¤ Processar (CSV Upload & Processing)        â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ğŸ“‹ InformaÃ§Ãµes (Stats & Results)              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ â“ Ajuda (Documentation)                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ğŸ”‘ Chaves API (Key Management)                â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAMADA DE NEGÃ“CIO            â”‚  â”‚  CAMADA DE DADOS            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                               â”‚  â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CSVProcessor          â”‚   â”‚  â”‚  â”‚  cache.db            â”‚  â”‚
â”‚  â”‚  â€¢ Read CSV            â”‚   â”‚  â”‚  â”‚  (Cached Results)    â”‚  â”‚
â”‚  â”‚  â€¢ Validate Data       â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  â€¢ Enrich with Geo     â”‚   â”‚  â”‚                              â”‚
â”‚  â”‚  â€¢ Generate Stats      â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚  .config/            â”‚  â”‚
â”‚  â”‚                             â”‚  â”‚  â”‚  api_keys.json       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚  (API Keys Storage) â”‚  â”‚
â”‚  â”‚  â”‚  CEPValidator          â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  â”‚  â€¢ Format Check        â”‚  â”‚  â”‚                             â”‚
â”‚  â”‚  â”‚  â€¢ Pattern Validation  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚  logs/               â”‚  â”‚
â”‚  â”‚                              â”‚  â”‚  â”‚  geografi.log        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚  (API Activity Log)  â”‚  â”‚
â”‚  â”‚  â”‚  Geocoder              â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  â”‚  â€¢ Via ViaCEP API      â”‚  â”‚  â”‚                              â”‚
â”‚  â”‚  â”‚  â€¢ Via Nominatim API   â”‚  â”‚  â”‚                              â”‚
â”‚  â”‚  â”‚  â€¢ Coordinate Gen      â”‚  â”‚  â”‚                              â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚                              â”‚
â”‚  â”‚                              â”‚  â”‚                              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚                              â”‚
â”‚  â”‚  â”‚  config.py             â”‚  â”‚  â”‚                              â”‚
â”‚  â”‚  â”‚  â€¢ APIConfig           â”‚  â”‚  â”‚                              â”‚
â”‚  â”‚  â”‚  â€¢ ProcessingConfig    â”‚  â”‚  â”‚                              â”‚
â”‚  â”‚  â”‚  â€¢ ColumnMapping       â”‚  â”‚  â”‚                              â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚                              â”‚
â”‚  â”‚                              â”‚  â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CAMADA DE INTEGRAÃ‡ÃƒO EXTERNA                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ViaCEP API  â”‚      â”‚  Nominatim   â”‚      â”‚   n8n Node   â”‚  â”‚
â”‚  â”‚  (CEP Data)  â”‚      â”‚  (Geocoding) â”‚      â”‚  (Workflow)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Fluxo de Dados

### CenÃ¡rio 1: Processamento via Web UI

```
UsuÃ¡rio acessa Streamlit
        â†“
Upload de arquivo CSV
        â†“
CSVProcessor processa dados
        â†“
Enriquecimento com coordenadas
        â†“
Download de resultado enriquecido
        â†“
Salvo em CSV/Excel
```

### CenÃ¡rio 2: IntegraÃ§Ã£o com n8n

```
n8n Workflow inicia
        â†“
HTTP POST para /api/process
        â†“
APIKeyManager valida autenticaÃ§Ã£o
        â†“
FastAPI roteia para endpoint
        â†“
CSVProcessor processa dados
        â†“
Resposta JSON com resultados
        â†“
n8n continua workflow
        â†“
Dados salvos em prÃ³ximo node
```

### CenÃ¡rio 3: ValidaÃ§Ã£o de Chaves

```
n8n envia requisiÃ§Ã£o HTTP
        â†“
Authorization: Bearer geo_xxx
        â†“
APIKeyManager.validate_api_key()
        â†“
âœ… VÃ¡lida â†’ Processa requisiÃ§Ã£o
âŒ InvÃ¡lida â†’ Retorna 401
        â†“
Registra uso em api_keys.json
```

---

## ğŸ” SeguranÃ§a - Camadas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Camada 1: GeraÃ§Ã£o de Chaves (Segura)  â”‚
â”‚  â†’ secrets.token_hex(32) = 64 chars    â”‚
â”‚  â†’ Formato: geo_<64_hex_characters>    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Camada 2: Armazenamento                â”‚
â”‚  â†’ Arquivo criptografado em .config/    â”‚
â”‚  â†’ NÃ£o em plain text no cÃ³digo          â”‚
â”‚  â†’ NÃ£o em variÃ¡veis globais             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Camada 3: TransmissÃ£o                  â”‚
â”‚  â†’ HTTPS em produÃ§Ã£o (recomendado)      â”‚
â”‚  â†’ Bearer Token no header               â”‚
â”‚  â†’ Sem exposiÃ§Ã£o em URL/body            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Camada 4: ValidaÃ§Ã£o                    â”‚
â”‚  â†’ VerificaÃ§Ã£o em cada requisiÃ§Ã£o       â”‚
â”‚  â†’ Status ativo obrigatÃ³rio             â”‚
â”‚  â†’ Rate limiting aplicado               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Camada 5: Auditoria                    â”‚
â”‚  â†’ Registra cada uso                    â”‚
â”‚  â†’ Timestamp do Ãºltimo acesso           â”‚
â”‚  â†’ Contador de requisiÃ§Ãµes              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Componentes e Responsabilidades

### 1. **APIKeyManager** (`api_key_manager.py`)

| MÃ©todo | Responsabilidade |
|--------|-----------------|
| `generate_api_key()` | Criar nova chave com seguranÃ§a |
| `validate_api_key()` | Verificar validade da chave |
| `get_api_key()` | Recuperar e rastrear uso |
| `list_api_keys()` | Listar chaves (com/sem secret) |
| `deactivate_api_key()` | Desativar sem deletar |
| `delete_api_key()` | Remover definitivamente |

### 2. **FastAPI Server** (`api_server.py`)

| Endpoint | AutenticaÃ§Ã£o | FunÃ§Ã£o |
|----------|-------------|--------|
| `/api/health` | NÃ£o | Verificar status |
| `/api/info` | NÃ£o | InformaÃ§Ãµes gerais |
| `/api/process` | Sim | Processar CSV |
| `/api/validate-cep` | Sim | Validar CEP |
| `/api/keys/list` | Sim | Listar chaves |
| `/api/keys/new` | Sim | Criar chave |
| `/api/integration-info` | NÃ£o | Info para n8n |

### 3. **Streamlit UI** (`app.py` + `pages/api_keys.py`)

| PÃ¡gina | FunÃ§Ã£o |
|--------|--------|
| ğŸ“¤ Processar | Upload e processamento manual |
| ğŸ“‹ InformaÃ§Ãµes | Ver estatÃ­sticas e resultados |
| â“ Ajuda | DocumentaÃ§Ã£o integrada |
| ğŸ”‘ Chaves API | Gerenciar chaves e integraÃ§Ã£o |

---

## ğŸ“ˆ Fluxo de AutenticaÃ§Ã£o

```
RequisiÃ§Ã£o HTTP com Header Authorization
        â†“
Extrair token do header
        â†“
Validar formato "Bearer <token>"
        â†“
Procurar token em api_keys.json
        â†“
Verificar se ativo
        â†“
âœ… Autorizar â†’ Atualizar last_used e usage_count
âŒ Rejeitar â†’ Retornar 401 Unauthorized
```

---

## ğŸ—‚ï¸ Estrutura de DiretÃ³rios

```
GeoGrafi_V2/
â”œâ”€â”€ app.py                          # App Streamlit principal
â”œâ”€â”€ api_run.py                      # Script para executar API
â”œâ”€â”€ test_api.py                     # Suite de testes
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ api_key_manager.py         # âœ¨ Novo: Gerenciador de chaves
â”‚   â”œâ”€â”€ api_server.py               # âœ¨ Novo: Servidor FastAPI
â”‚   â”œâ”€â”€ cache_manager.py
â”‚   â”œâ”€â”€ cep_validator.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ csv_processor.py
â”‚   â”œâ”€â”€ csv_reader.py
â”‚   â”œâ”€â”€ geocoder.py
â”‚   â”œâ”€â”€ logging_config.py
â”‚   â”œâ”€â”€ streamlit_components.py
â”‚   â””â”€â”€ utils.py
â”‚
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ api_keys.py                 # âœ¨ Novo: Interface web de chaves
â”‚
â”œâ”€â”€ requirements.txt                # Atualizado com FastAPI e Uvicorn
â”œâ”€â”€ .env.example                    # âœ¨ Novo: VariÃ¡veis de ambiente
â”‚
â”œâ”€â”€ N8N_INTEGRATION.md              # âœ¨ Novo: DocumentaÃ§Ã£o completa
â”œâ”€â”€ QUICK_START_N8N.md              # âœ¨ Novo: Guia rÃ¡pido
â”œâ”€â”€ UPDATES_SUMMARY.md              # âœ¨ Novo: SumÃ¡rio de atualizaÃ§Ãµes
â”œâ”€â”€ n8n-workflow-example.json       # âœ¨ Novo: Workflow exemplo
â”‚
â”œâ”€â”€ .config/
â”‚   â””â”€â”€ api_keys.json               # Arquivo de chaves API (criado automaticamente)
â”‚
â””â”€â”€ logs/
    â””â”€â”€ geografi.log                # Logs da aplicaÃ§Ã£o (criado automaticamente)
```

---

## ğŸš€ Deploy e Escalabilidade

### Desenvolvimento Local
```bash
# Terminal 1: Streamlit Web
python -m streamlit run app.py

# Terminal 2: API REST
python api_run.py
```

### ProduÃ§Ã£o com Docker
```dockerfile
FROM python:3.10-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

# MÃºltiplas portas
EXPOSE 8501 8000

CMD ["sh", "-c", "streamlit run app.py & python api_run.py --host 0.0.0.0"]
```

### Escalabilidade
- API stateless â†’ Pode ter mÃºltiplas instÃ¢ncias
- Chaves armazenadas em arquivo â†’ Pode usar banco de dados
- Cache local â†’ Pode usar Redis
- Logs â†’ Pode usar ELK stack

---

## ğŸ“‹ Checklist de Funcionalidades

- âœ… Gerenciamento de chaves API
- âœ… API REST com autenticaÃ§Ã£o Bearer
- âœ… Endpoints para processar CSV
- âœ… ValidaÃ§Ã£o de CEP via API
- âœ… DocumentaÃ§Ã£o Swagger/OpenAPI
- âœ… Interface web para gerenciar chaves
- âœ… Rastreamento de uso de chaves
- âœ… DocumentaÃ§Ã£o n8n completa
- âœ… Guia rÃ¡pido (5 passos)
- âœ… Exemplo de workflow n8n
- âœ… Suite de testes
- âœ… VariÃ¡veis de ambiente

---

## ğŸ¯ PrÃ³ximas IntegraÃ§Ãµes (Roadmap)

- [ ] Dashboard de uso de API
- [ ] Rate limiting por IP/chave
- [ ] Webhooks automÃ¡ticos
- [ ] OAuth2 authentication
- [ ] Cache distribuÃ­do (Redis)
- [ ] GraphQL endpoint
- [ ] Suporte a mÃºltiplas bases de geocodificaÃ§Ã£o
- [ ] IntegraÃ§Ã£o com Zapier
- [ ] IntegraÃ§Ã£o com Power Automate

---

**VersÃ£o:** 2.0
**Data:** 20 de janeiro de 2026
**Status:** âœ… ProduÃ§Ã£o Ready

